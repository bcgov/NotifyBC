(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{425:function(t,e,i){"use strict";i.r(e);var s=i(42),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[i("div",{staticClass:"custom-block warning"},[i("p",{staticClass:"custom-block-title"},[t._v("tl;dr")]),t._v(" "),i("p",[t._v("A "),i("i",[t._v("NotifyBC")]),t._v(" server node can deliver 1 million emails in as little as 1 hour to a SMTP server node. SMTP server node's disk I/O is the bottleneck in such case. Throughput can be improved through horizontal scaling.")])]),t._v(" "),i("p",[t._v("When "),i("em",[t._v("NotifyBC")]),t._v(" is used to deliver broadcast push notifications to a large number of subscribers, probably the most important benchmark is throughput. The benchmark is especially critical if a latency cap is desired. To facilitate capacity planning, load testing on the email channel has been conducted. The test environment, procedure, results and performance tuning advices are provided hereafter.")]),t._v(" "),i("h2",{attrs:{id:"environment"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#environment"}},[t._v("#")]),t._v(" Environment")]),t._v(" "),i("h3",{attrs:{id:"hardware"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#hardware"}},[t._v("#")]),t._v(" Hardware")]),t._v(" "),i("p",[t._v("Two computers, connected by 1Gbps LAN, are used to host")]),t._v(" "),i("ul",[i("li",[i("em",[t._v("NotifyBC")]),t._v(" "),i("ul",[i("li",[t._v("Mac Mini Late 2012 model")]),t._v(" "),i("li",[t._v("Intel core i7-3615QM")]),t._v(" "),i("li",[t._v("16GB RAM")]),t._v(" "),i("li",[t._v("2TB HDD")])])]),t._v(" "),i("li",[t._v("SMTP and mail delivery\n"),i("ul",[i("li",[t._v("Lenovo ThinkCentre M Series 2015 model")]),t._v(" "),i("li",[t._v("Intel core i5-3470")]),t._v(" "),i("li",[t._v("8GB RAM")]),t._v(" "),i("li",[t._v("256GB SSD")])])])]),t._v(" "),i("h3",{attrs:{id:"software-stack"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#software-stack"}},[t._v("#")]),t._v(" Software Stack")]),t._v(" "),i("p",[t._v("The test was performed in August 2017. Unless otherwise specified, the versions of all other software were reasonably up-to-date at the time of testing.")]),t._v(" "),i("ul",[i("li",[i("p",[i("em",[t._v("NotifyBC")])]),t._v(" "),i("ul",[i("li",[t._v("MacOS Sierra Version 10.12.6")]),t._v(" "),i("li",[t._v("Virtualbox VM with 8vCPU, 10GB RAM, created using miniShift v1.3.1+f4900b07")]),t._v(" "),i("li",[t._v("OpenShift 1.5.1+7b451fc with metrics")]),t._v(" "),i("li",[t._v("default "),i("em",[t._v("NotifyBC")]),t._v(" OpenShift installation, which contains following relevant pods\n"),i("ul",[i("li",[t._v("1 mongodb pod with 1 core, 1GiB RAM limit")]),t._v(" "),i("li",[t._v("a variable number of Nodejs app pods each with 1 core, 1GiB RAM limit. The number varies by test runs as indicated in result.")])])])])]),t._v(" "),i("li",[i("p",[t._v("SMTP and mail delivery")]),t._v(" "),i("ul",[i("li",[t._v("Windows 7 host")]),t._v(" "),i("li",[t._v("Virtualbox VM with 4 vCPU, 3.5GB RAM, running Windows Server 2012")]),t._v(" "),i("li",[t._v("added SMTP Server feature")]),t._v(" "),i("li",[t._v("in SMTP Server properties dialog box, uncheck all of following boxes in "),i("em",[t._v("Messages")]),t._v(" tab\n"),i("ul",[i("li",[t._v("Limit message size to (KB)")]),t._v(" "),i("li",[t._v("Limit session size to (KB)")]),t._v(" "),i("li",[t._v("Limit number of messages per connection to")]),t._v(" "),i("li",[t._v("Limit number of recipients per message to")])])])])])]),t._v(" "),i("h2",{attrs:{id:"procedure"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#procedure"}},[t._v("#")]),t._v(" Procedure")]),t._v(" "),i("ol",[i("li",[i("p",[t._v("update or create file "),i("em",[t._v("/server/config.local.js")]),t._v(" through "),i("RouterLink",{attrs:{to:"/docs/installation/#update-configuration-files"}},[t._v("configMap")]),t._v(". Add sections for SMTP server and a custom filter function")],1),t._v(" "),i("div",{staticClass:"language- extra-class"},[i("pre",{pre:!0,attrs:{class:"language-text"}},[i("code",[t._v("var _ = require('lodash')\nmodule.exports = {\n  ...\n  smtp: {\n    host: '<smtp-vm-ip-or-hostname>',\n    secure: false,\n    port: 25,\n    pool: true,\n    direct: false,\n    maxMessages: Infinity,\n    maxConnections: 50\n  },\n  ...\n  notification: {\n    broadcastCustomFilterFunctions: {\n      /*jshint camelcase: false */\n      contains_ci: {\n        _func: function(resolvedArgs) {\n          if (!resolvedArgs[0] || !resolvedArgs[1]) {\n            return false\n          }\n          return (\n            _.toLower(resolvedArgs[0]).indexOf(\n             _.toLower(resolvedArgs[1])) >= 0\n          )\n        },\n        _signature: [\n          {\n            types: [2]\n          },\n          {\n            types: [2]\n          }\n        ]\n      }\n    }\n  }\n}\n")])])])]),t._v(" "),i("li",[i("p",[t._v("create a number of subscriptions in bulk using script "),i("a",{attrs:{href:"https://github.com/bcgov/NotifyBC/blob/master/utils/load-testing/bulk-post-subs.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("bulk-post-subs.js"),i("OutboundLink")],1),t._v(". To load test different email volumes, you can create bulk subscriptions in different services. For example, generate 10 subscriptions under service named "),i("em",[t._v("load10")]),t._v("; 1,000,000 subscriptions under service "),i("em",[t._v("load1000000")]),t._v(" etc. "),i("em",[t._v("bulk-post-subs.js")]),t._v(" takes "),i("em",[t._v("userChannelId")]),t._v(" and other optional parameters")]),t._v(" "),i("div",{staticClass:"language- extra-class"},[i("pre",{pre:!0,attrs:{class:"language-text"}},[i("code",[t._v("$ node utils/load-testing/bulk-post-subs.js -h\nUsage: node bulk-post-subs.js [Options] <userChannelId>\n[Options]:\n-a, --api-url-prefix=<string>                      api url prefix. default to http://localhost:3000/api\n-c, --channel=<string>                             channel. default to email\n-s, --service-name=<string>                        service name. default to load\n-n, --number-of-subscribers=<int>                  number of subscribers. positive integer. default to 1000\n-f, --broadcast-push-notification-filter=<string>  broadcast push notification filter. default to \"contains_ci(title,'vancouver') || contains_ci(title,'victoria')\"\n-h, --help                                         display this help\n")])])]),i("p",[t._v("The generated subscriptions contain a filter, hence all load testing results below included time spent on filtering.")])]),t._v(" "),i("li",[i("p",[t._v("launch load testing using script "),i("a",{attrs:{href:"https://github.com/bcgov/NotifyBC/blob/master/utils/load-testing/curl-ntf.sh",target:"_blank",rel:"noopener noreferrer"}},[t._v("curl-ntf.sh"),i("OutboundLink")],1),t._v(", which takes following optional parameters")]),t._v(" "),i("div",{staticClass:"language- extra-class"},[i("pre",{pre:!0,attrs:{class:"language-text"}},[i("code",[t._v("utils/load-testing/curl-ntf.sh <apiUrlPrefix> <serviceName> <senderEmail>\n")])])]),i("p",[t._v("The script will print start time and the time taken to dispatch the notification.")])])]),t._v(" "),i("h2",{attrs:{id:"results"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#results"}},[t._v("#")]),t._v(" Results")]),t._v(" "),i("table",[i("thead",[i("tr",[i("th",{staticStyle:{"text-align":"right"}},[t._v("email count")]),t._v(" "),i("th",{staticStyle:{"text-align":"right"}},[t._v("time taken (min)")]),t._v(" "),i("th",{staticStyle:{"text-align":"right"}},[t._v("throughput (#/min)")]),t._v(" "),i("th",{staticStyle:{"text-align":"right"}},[t._v("app pod count")]),t._v(" "),i("th",[t._v("notes on bottleneck")])])]),t._v(" "),i("tbody",[i("tr",[i("td",{staticStyle:{"text-align":"right"}},[t._v("1,000,000")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("71.5")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("13,986")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("1")]),t._v(" "),i("td",[t._v("app pod cpu capped")])]),t._v(" "),i("tr",[i("td",{staticStyle:{"text-align":"right"}},[t._v("100,000")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("5.8")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("17,241")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("2")]),t._v(" "),i("td",[t._v("smtp vm disk queue length hits 1 frequently")])]),t._v(" "),i("tr",[i("td",{staticStyle:{"text-align":"right"}},[t._v("1,000,000")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("57")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("17,544")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("2")]),t._v(" "),i("td",[t._v("smtp vm disk queue length hits 1 frequently")])]),t._v(" "),i("tr",[i("td",{staticStyle:{"text-align":"right"}},[t._v("1,000,000")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("57.8")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("17,301")]),t._v(" "),i("td",{staticStyle:{"text-align":"right"}},[t._v("3")]),t._v(" "),i("td",[t._v("smtp vm disk queue length hits 1 frequently")])])])]),t._v(" "),i("p",[t._v("Test runs using other software or configurations described below have also been conducted. Because throughput is significantly lower, results are not shown")]),t._v(" "),i("ul",[i("li",[t._v("using Linux sendmail SMTP. The throughput of a 4-vCPU Linux VM is about the same as a 1-vCPU Windows SMTP server. Bottleneck in such case is the CPU of SMTP server.")]),t._v(" "),i("li",[t._v("Reducing "),i("em",[t._v("NotifyBC")]),t._v(" app pod's resource limit to 100 millicore CPU and 512MiB RAM. Even when scaled up pod count to 15, throughput is still about 1/3 of a 1-core pod.")])]),t._v(" "),i("p",[i("a",{attrs:{href:"../../attachments/benchmark-email.txt"}},[t._v("Here")]),t._v(" is a sample email saved onto the mail drop folder of SMTP server.")]),t._v(" "),i("h3",{attrs:{id:"comparison-to-other-benchmarks"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#comparison-to-other-benchmarks"}},[t._v("#")]),t._v(" Comparison to Other Benchmarks")]),t._v(" "),i("p",[t._v("According to "),i("a",{attrs:{href:"https://technet.microsoft.com/en-us/library/bb124213(v=exchg.65).aspx",target:"_blank",rel:"noopener noreferrer"}},[t._v("Baseline Performance for SMTP"),i("OutboundLink")],1),t._v(" published on Microsoft Technet in 2005, Windows SMTP server has a max throughput of 142 emails/s. However this "),i("em",[t._v("NotifyBC")]),t._v(" load test yields a max throughput of 292 emails/s. The discrepancy may be attributed to following factors")]),t._v(" "),i("ol",[i("li",[t._v("Email size in Microsoft's load test is 50k, as opposed to 1k used in this test")]),t._v(" "),i("li",[t._v("SSD storage is used in this test. It is unlikely the test conducted in 2005 used SSD.")])]),t._v(" "),i("h2",{attrs:{id:"advices"}},[i("a",{staticClass:"header-anchor",attrs:{href:"#advices"}},[t._v("#")]),t._v(" Advices")]),t._v(" "),i("ul",[i("li",[t._v("Avoid using default direct mode in production. Instead use SMTP server. Direct mode doesn't support connection pooling, resulting in port depletion quickly.")]),t._v(" "),i("li",[t._v("Enable SMTP "),i("a",{attrs:{href:"https://nodemailer.com/smtp/pooled/",target:"_blank",rel:"noopener noreferrer"}},[t._v("pooling"),i("OutboundLink")],1),t._v(".")]),t._v(" "),i("li",[t._v("Set smtp config "),i("em",[t._v("maxConnections")]),t._v(" to a number big enough as long as SMTP server can handle. Test found for Windows SMTP server 50 is a suitable number, beyond which performance gain is insignificant.")]),t._v(" "),i("li",[t._v("Set smtp config "),i("em",[t._v("maxMessages")]),t._v(" to maximum possible number allowed by your SMTP server, or "),i("em",[t._v("Infinity")]),t._v(" if SMTP server imposes no such constraint")]),t._v(" "),i("li",[t._v("Avoid setting CPU resource limit too low for "),i("em",[t._v("NotifyBC")]),t._v(" app pods.")]),t._v(" "),i("li",[t._v("If you have control over the SMTP server,\n"),i("ul",[i("li",[t._v("use SSD for its storage")]),t._v(" "),i("li",[t._v("create a load balanced cluster if possible, since SMTP server is more likely to be the bottleneck.")])])])])])}),[],!1,null,null,null);e.default=n.exports}}]);