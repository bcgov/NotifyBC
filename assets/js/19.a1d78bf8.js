(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{467:function(e,t,s){"use strict";s.r(t);var a=s(58),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"tls-certificates"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#tls-certificates"}},[e._v("#")]),e._v(" TLS Certificates")]),e._v(" "),s("p",[s("em",[e._v("NotifyBC")]),e._v(" supports HTTPS TLS to achieve end-to-end encryption. In addition, both server and client can be authenticated using certificates.")]),e._v(" "),s("p",[e._v("To enable HTTPS for server authentication only, you need to create two files")]),e._v(" "),s("ul",[s("li",[s("em",[e._v("server/certs/key.pem")]),e._v(" - a PEM encoded private key")]),e._v(" "),s("li",[s("em",[e._v("server/certs/cert.pem")]),e._v(" - a PEM encoded X.509 certificate chain")])]),e._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[e._v("Use ConfigMaps on Kubernetes")]),e._v(" "),s("p",[e._v("Create "),s("em",[e._v("key.pem")]),e._v(" and "),s("em",[e._v("cert.pem")]),e._v(" as items in ConfigMap "),s("em",[e._v("notify-bc")]),e._v(", then mount the items under "),s("em",[e._v("/home/node/app/server/certs")]),e._v(" similar to how "),s("em",[e._v("config.local.js")]),e._v(" and "),s("em",[e._v("middleware.local.js")]),e._v(" are implemented.")])]),e._v(" "),s("p",[e._v("For self-signed certificate, run")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("openssl req -x509 -newkey rsa:4096 -keyout server/certs/key.pem -out server/certs/cert.pem -nodes -days "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("365")]),e._v(" -subj "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/CN=NotifyBC"')]),e._v("\n")])])]),s("p",[e._v("to generate both files in one shot.")]),e._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[e._v("Caution about self-signed cert")]),e._v(" "),s("p",[e._v("Self-signed cert is intended to be used in non-production environments only to authenticate server. In such environments to allow "),s("em",[e._v("NotifyBC")]),e._v(" connecting to itself, environment variable NODE_TLS_REJECT_UNAUTHORIZED must be set to 0.")])]),e._v(" "),s("p",[e._v("To create a CSR from the private key generated above, run")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("openssl req -new -key server/certs/key.pem -out server/certs/csr.pem\n")])])]),s("p",[e._v("Then bring your CSR to your CA to sign. Replace "),s("em",[e._v("server/certs/cert.pem")]),e._v(" with the cert signed by CA. If your CA also supplied intermediate certificate in PEM encoded format, say in a file called "),s("em",[e._v("intermediate.pem")]),e._v(", append all of the content of "),s("em",[e._v("intermediate.pem")]),e._v(" to file "),s("em",[e._v("server/certs/cert.pem")]),e._v(".")]),e._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[e._v("Make a copy of self-signed server/certs/cert.pem")]),e._v(" "),s("p",[e._v("If you want to enable "),s("a",{attrs:{href:"#client-certificate-authentication"}},[e._v("client certificate authentication")]),e._v(" documented below, make sure to copy self-signed "),s("em",[e._v("server/certs/cert.pem")]),e._v(" to "),s("em",[e._v("server/certs/ca.pem")]),e._v(" before replacing the file with the cert signed by CA.\nYou need the self-signed "),s("em",[e._v("server/certs/cert.pem")]),e._v(" to sign client CSR.")])]),e._v(" "),s("p",[e._v("In case you created "),s("em",[e._v("server/certs/key.pem")]),e._v(" and "),s("em",[e._v("server/certs/cert.pem")]),e._v(" but don't want to enable HTTPS, create following config in "),s("em",[e._v("src/config.local.js")])]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[e._v("module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[e._v("tls")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[e._v("enabled")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[e._v("Update URL configs after enabling HTTPS")]),e._v(" "),s("p",[e._v("Make sure to update the protocol of following URL configs after enabling HTTPS")]),e._v(" "),s("ul",[s("li",[s("RouterLink",{attrs:{to:"/docs/config/httpHost.html"}},[e._v("httpHost")])],1),e._v(" "),s("li",[s("RouterLink",{attrs:{to:"/docs/config/internalHttpHost.html"}},[e._v("internalHttpHost")])],1)])]),e._v(" "),s("h2",{attrs:{id:"client-certificate-authentication"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client-certificate-authentication"}},[e._v("#")]),e._v(" Client certificate authentication")]),e._v(" "),s("p",[e._v("After enabling HTTPS, you can further configure such that a client request can be authenticated using client certificate. To do so, copy self-signed "),s("em",[e._v("server/certs/cert.pem")]),e._v(" to "),s("em",[e._v("server/certs/ca.pem")]),e._v(". You will use your server key to sign client certificate CSR, and advertise "),s("em",[e._v("server/certs/ca.pem")]),e._v(" as acceptable CAs during TLS handshake.")]),e._v(" "),s("p",[e._v("Assuming a client's CSR file is named "),s("em",[e._v("myClientApp_csr.pem")]),e._v(", to sign the CSR")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("openssl x509 -req -in myClientApp_csr.pem -CA server/certs/ca.pem -CAkey server/certs/key.pem -out myClientApp_cert.pem -set_serial 01 -days "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("365")]),e._v("\n")])])]),s("p",[e._v("Then give "),s("em",[e._v("myClientApp_cert.pem")]),e._v(" to the client. How a client app supplies the client certificate when making a request to "),s("em",[e._v("NotifyBC")]),e._v(" varies by client type. Usually the client first needs to bundle the signed client cert and client key into PKCS#12 format")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[e._v("openssl pkcs12 -export -clcerts -in myClientApp_cert.pem -inkey myClientApp_key.pem -out myClientApp.p12\n")])])]),s("p",[e._v("To use "),s("em",[e._v("myClientApp.p12")]),e._v(", for cURL,")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("curl")]),e._v(" --insecure --cert myClientApp.p12 --cert-type p12 https://localhost:3000/api/administrators/whoami\n")])])]),s("p",[e._v("For browsers, check browser's instruction how to import "),s("em",[e._v("myClientApp.p12")]),e._v(". When browser accessing "),s("em",[e._v("NotifyBC")]),e._v(" API endpoints such as "),s("em",[e._v("https://localhost:3000/api/administrators/whoami")]),e._v(", the browser will prompt to choose from a list certificates that are signed by the server certificate.")]),e._v(" "),s("p",[e._v("In case you created "),s("em",[e._v("server/certs/ca.pem")]),e._v(" but don't want to enable client certificate authentication, create following config in "),s("em",[e._v("src/config.local.js")])]),e._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[e._v("module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[e._v("tls")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[e._v("clientCertificateEnabled")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[e._v("TLS termination has to be passthrough")]),e._v(" "),s("p",[e._v("For client certification authentication to work, TLS termination of all reverse proxies has to be set to passthrough rather than offload and reload. This means, for example, when "),s("em",[e._v("NotifyBC")]),e._v(" is hosted on OpenShift, router "),s("a",{attrs:{href:"https://github.com/bcgov/NotifyBC/blob/main/helm/values.yaml#L140",target:"_blank",rel:"noopener noreferrer"}},[e._v("tls termination"),s("OutboundLink")],1),e._v(" has to be changed from "),s("em",[e._v("edge")]),e._v(" to "),s("em",[e._v("passthrough")]),e._v(".")])]),e._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[s("i",[e._v("NotifyBC")]),e._v(" internal request does not use client certificate")]),e._v(" "),s("p",[e._v("Requests sent by a "),s("em",[e._v("NotifyBC")]),e._v(" node back to the app cluster use admin ip list authentication.")])])])}),[],!1,null,null,null);t.default=n.exports}}]);