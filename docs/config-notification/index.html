<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Notification | NotifyBC</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" type="image/x-icon" href="/NotifyBC/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <meta name="description" content="A versatile notification API server">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/NotifyBC/assets/css/0.styles.fc7924f6.css" as="style"><link rel="preload" href="/NotifyBC/assets/js/app.de6582d6.js" as="script"><link rel="preload" href="/NotifyBC/assets/js/4.f52469e6.js" as="script"><link rel="preload" href="/NotifyBC/assets/js/5.837d8809.js" as="script"><link rel="preload" href="/NotifyBC/assets/js/27.1fc62055.js" as="script"><link rel="prefetch" href="/NotifyBC/assets/js/1.49c88643.js"><link rel="prefetch" href="/NotifyBC/assets/js/10.8dd2695b.js"><link rel="prefetch" href="/NotifyBC/assets/js/11.eddc8f05.js"><link rel="prefetch" href="/NotifyBC/assets/js/12.e226932a.js"><link rel="prefetch" href="/NotifyBC/assets/js/13.b5014188.js"><link rel="prefetch" href="/NotifyBC/assets/js/14.2f57401a.js"><link rel="prefetch" href="/NotifyBC/assets/js/15.7b088343.js"><link rel="prefetch" href="/NotifyBC/assets/js/16.d222a615.js"><link rel="prefetch" href="/NotifyBC/assets/js/17.5ff580d5.js"><link rel="prefetch" href="/NotifyBC/assets/js/18.f2e81adf.js"><link rel="prefetch" href="/NotifyBC/assets/js/19.a1d78bf8.js"><link rel="prefetch" href="/NotifyBC/assets/js/20.a426f95a.js"><link rel="prefetch" href="/NotifyBC/assets/js/21.8db838cd.js"><link rel="prefetch" href="/NotifyBC/assets/js/22.09667571.js"><link rel="prefetch" href="/NotifyBC/assets/js/23.de6d6501.js"><link rel="prefetch" href="/NotifyBC/assets/js/24.fd8808d2.js"><link rel="prefetch" href="/NotifyBC/assets/js/25.9857f3dc.js"><link rel="prefetch" href="/NotifyBC/assets/js/26.4863bd35.js"><link rel="prefetch" href="/NotifyBC/assets/js/28.4ddb24b0.js"><link rel="prefetch" href="/NotifyBC/assets/js/29.e54866fc.js"><link rel="prefetch" href="/NotifyBC/assets/js/30.2ebb0726.js"><link rel="prefetch" href="/NotifyBC/assets/js/31.3944f5c3.js"><link rel="prefetch" href="/NotifyBC/assets/js/32.4310790d.js"><link rel="prefetch" href="/NotifyBC/assets/js/33.ff101a0c.js"><link rel="prefetch" href="/NotifyBC/assets/js/34.233c9ff0.js"><link rel="prefetch" href="/NotifyBC/assets/js/35.c7956bcc.js"><link rel="prefetch" href="/NotifyBC/assets/js/36.93da2255.js"><link rel="prefetch" href="/NotifyBC/assets/js/37.151eb052.js"><link rel="prefetch" href="/NotifyBC/assets/js/38.a5b24c60.js"><link rel="prefetch" href="/NotifyBC/assets/js/39.3c86ad68.js"><link rel="prefetch" href="/NotifyBC/assets/js/40.ea1b47b4.js"><link rel="prefetch" href="/NotifyBC/assets/js/41.83091c15.js"><link rel="prefetch" href="/NotifyBC/assets/js/42.e4e4a4ad.js"><link rel="prefetch" href="/NotifyBC/assets/js/43.d33791d2.js"><link rel="prefetch" href="/NotifyBC/assets/js/44.88084306.js"><link rel="prefetch" href="/NotifyBC/assets/js/45.60dcbea1.js"><link rel="prefetch" href="/NotifyBC/assets/js/46.9f6bde65.js"><link rel="prefetch" href="/NotifyBC/assets/js/47.6b1813df.js"><link rel="prefetch" href="/NotifyBC/assets/js/6.ab3fcdb0.js"><link rel="prefetch" href="/NotifyBC/assets/js/7.7e2decb2.js"><link rel="prefetch" href="/NotifyBC/assets/js/8.0c6db138.js"><link rel="prefetch" href="/NotifyBC/assets/js/9.79d173aa.js"><link rel="prefetch" href="/NotifyBC/assets/js/vendors~docsearch.bb73c573.js">
    <link rel="stylesheet" href="/NotifyBC/assets/css/0.styles.fc7924f6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/NotifyBC/" class="home-link router-link-active"><img src="/NotifyBC/img/logo.svg" alt="NotifyBC" class="logo"></a> <!----> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/NotifyBC/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/NotifyBC/docs/" class="nav-link router-link-active">
  Docs
</a></div><div class="nav-item"><a href="/NotifyBC/help/" class="nav-link">
  Help
</a></div> <a href="https://github.com/bcgov/NotifyBC" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/NotifyBC/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/NotifyBC/docs/" class="nav-link router-link-active">
  Docs
</a></div><div class="nav-item"><a href="/NotifyBC/help/" class="nav-link">
  Help
</a></div> <a href="https://github.com/bcgov/NotifyBC" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Getting Started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/NotifyBC/docs/" aria-current="page" class="sidebar-link">Welcome</a></li><li><a href="/NotifyBC/docs/overview/" class="sidebar-link">Overview</a></li><li><a href="/NotifyBC/docs/quickstart/" class="sidebar-link">Quick Start</a></li><li><a href="/NotifyBC/docs/installation/" class="sidebar-link">Installation</a></li><li><a href="/NotifyBC/docs/web-console/" class="sidebar-link">Web Console</a></li><li><a href="/NotifyBC/docs/what's-new/" class="sidebar-link">What's New</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Configuration</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/NotifyBC/docs/config-overview/" class="sidebar-link">Configuration Overview</a></li><li><a href="/NotifyBC/docs/config-database/" class="sidebar-link">Database</a></li><li><a href="/NotifyBC/docs/config-adminIpList/" class="sidebar-link">Admin IP List</a></li><li><a href="/NotifyBC/docs/config-reverseProxyIpLists/" class="sidebar-link">Reverse Proxy IP Lists</a></li><li><a href="/NotifyBC/docs/config-httpHost/" class="sidebar-link">HTTP Host</a></li><li><a href="/NotifyBC/docs/config-internalHttpHost/" class="sidebar-link">Internal HTTP Host</a></li><li><a href="/NotifyBC/docs/config-email/" class="sidebar-link">Email</a></li><li><a href="/NotifyBC/docs/config-sms/" class="sidebar-link">SMS</a></li><li><a href="/NotifyBC/docs/config-subscription/" class="sidebar-link">Subscription</a></li><li><a href="/NotifyBC/docs/config-notification/" aria-current="page" class="active sidebar-link">Notification</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/NotifyBC/docs/config-notification/#rss-feeds" class="sidebar-link">RSS Feeds</a></li><li class="sidebar-sub-header"><a href="/NotifyBC/docs/config-notification/#broadcast-push-notification-task-concurrency" class="sidebar-link">Broadcast Push Notification Task Concurrency</a></li><li class="sidebar-sub-header"><a href="/NotifyBC/docs/config-notification/#broadcast-push-notification-custom-filter-functions" class="sidebar-link">Broadcast Push Notification Custom Filter Functions</a></li><li class="sidebar-sub-header"><a href="/NotifyBC/docs/config-notification/#guaranteed-broadcast-push-dispatch-processing" class="sidebar-link">Guaranteed Broadcast Push Dispatch Processing</a></li></ul></li><li><a href="/NotifyBC/docs/config-nodeRoles/" class="sidebar-link">Node Roles</a></li><li><a href="/NotifyBC/docs/config-cronJobs/" class="sidebar-link">Cron Jobs</a></li><li><a href="/NotifyBC/docs/config-rsaKeys/" class="sidebar-link">RSA Keys</a></li><li><a href="/NotifyBC/docs/config-workerProcessCount/" class="sidebar-link">Worker Process Count</a></li><li><a href="/NotifyBC/docs/config-middleware/" class="sidebar-link">Middleware</a></li><li><a href="/NotifyBC/docs/config-oidc/" class="sidebar-link">OIDC</a></li><li><a href="/NotifyBC/docs/config-certificates/" class="sidebar-link">TLS Certificates</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/NotifyBC/docs/api-overview/" class="sidebar-link">API Overview</a></li><li><a href="/NotifyBC/docs/api-subscription/" class="sidebar-link">Subscription</a></li><li><a href="/NotifyBC/docs/api-notification/" class="sidebar-link">Notification</a></li><li><a href="/NotifyBC/docs/api-config/" class="sidebar-link">Configuration</a></li><li><a href="/NotifyBC/docs/api-administrator/" class="sidebar-link">Administrator</a></li><li><a href="/NotifyBC/docs/api-bounce/" class="sidebar-link">Bounce</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Miscellaneous</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/NotifyBC/docs/benchmarks/" class="sidebar-link">Benchmarks</a></li><li><a href="/NotifyBC/docs/bulk-import/" class="sidebar-link">Bulk Import</a></li><li><a href="/NotifyBC/docs/developer-notes/" class="sidebar-link">Developer Notes</a></li><li><a href="/NotifyBC/docs/upgrade/" class="sidebar-link">Upgrade Guide</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Meta</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/NotifyBC/docs/conduct/" class="sidebar-link">Code of Conduct</a></li><li><a href="/NotifyBC/docs/acknowledgments/" class="sidebar-link">Acknowledgments</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="notification"><a href="#notification" class="header-anchor">#</a> Notification</h1> <p>Configs in this section customize the handling of notification request or generating notifications from RSS feeds. They are all sub-properties of config object <em>notification</em>. Service-agnostic configs are static and service-dependent configs are dynamic.</p> <h2 id="rss-feeds"><a href="#rss-feeds" class="header-anchor">#</a> RSS Feeds</h2> <p><em>NotifyBC</em> can generate broadcast push notifications automatically by polling RSS feeds periodically and detect changes by comparing with an internally maintained history list. The polling frequency, RSS url, RSS item change detection criteria, and message template can be defined in dynamic configs.</p> <div class="custom-block danger"><p class="custom-block-title">Only first page is retrieved for paginated RSS feeds</p> <p>If a RSS feed is paginated, <i>NotifyBC</i> only retrieves the first page rather than auto-fetch subsequent pages. Hence paginated RSS feeds should be sorted descendingly by last modified timestamp. Refresh interval should be adjusted small enough such that all new or updated items are contained in first page.</p></div> <p>For example, to notify subscribers of <em>myService</em> on updates to feed <em>http://my-serivce/rss</em>, create following config item using <a href="/NotifyBC/docs/api-config/#create-a-configuration">POST configuration API</a></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;notification&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;serviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;myService&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;rss&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://my-serivce/rss&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;timeSpec&quot;</span><span class="token operator">:</span> <span class="token string">&quot;* * * * *&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;itemKeyField&quot;</span><span class="token operator">:</span> <span class="token string">&quot;guid&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;outdatedItemRetentionGenerations&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">&quot;includeUpdatedItems&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">&quot;fieldsToCheckForUpdate&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pubDate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;description&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;httpHost&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:3000&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;messageTemplates&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;from&quot;</span><span class="token operator">:</span> <span class="token string">&quot;no_reply@invlid.local&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;subject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{title}&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;textBody&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{description}&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;htmlBody&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{description}&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;sms&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;textBody&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{description}&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The config items in the <em>value</em> field are</p> <ul><li>rss
<ul><li>url: RSS url</li> <li><a name="timeSpec"></a>timeSpec: RSS poll frequency, a space separated fields conformed to <a href="https://www.freebsd.org/cgi/man.cgi?crontab(5)" target="_blank" rel="noopener noreferrer">unix crontab format<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> with an optional left-most seconds field. See <a href="https://github.com/kelektiv/node-cron#cron-ranges" target="_blank" rel="noopener noreferrer">allowed ranges<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of each field</li> <li>itemKeyField: rss item's unique key field to identify new items. By default <em>guid</em></li> <li>outdatedItemRetentionGenerations: number of last consecutive polls from which results an item has to be absent before the item can be removed from the history list. This config is designed to prevent multiple notifications triggered by the same item because RSS poll returns inconsistent results, usually due to a combination of pagination and lack of sorting. By default 1, meaning the history list only keeps the last poll result</li> <li>includeUpdatedItems: whether to notify also updated items or just new items. By default <em>false</em></li> <li>fieldsToCheckForUpdate: list of fields to check for updates if <em>includeUpdatedItems</em> is <em>true</em>. By default <em>[&quot;pubDate&quot;]</em></li></ul></li> <li>httpHost: the http protocol, host and port used by <a href="/NotifyBC/docs/overview/#mail-merge">mail merge</a>. If missing, the value is auto-populated based on the REST request that creates this config item.</li> <li>messageTemplates: channel-specific message templates with channel name as the key. <em>NotifyBC</em> generates a notification for each channel specified in the message templates. Message template fields are the same as those in <a href="/NotifyBC/docs/api-notification/#field-message">notification api</a>. Message template fields support dynamic token.</li></ul> <h2 id="broadcast-push-notification-task-concurrency"><a href="#broadcast-push-notification-task-concurrency" class="header-anchor">#</a> Broadcast Push Notification Task Concurrency</h2> <p>To achieve horizontal scaling, when a broadcast push notification request, hereby known as original request, is received, <em>NotifyBC</em> divides subscribers into chunks and generates a HTTP sub-request for each chunk. The original request supervises the execution of sub-requests. The chunk size is defined by config <em>broadcastSubscriberChunkSize</em>. All subscribers in a sub-request chunk are processed concurrently when the sub-requests are submitted.</p> <p>The original request submits sub-requests back to (preferably load-balanced) <em>NotifyBC</em> server cluster for processing. Sub-request submission is throttled by config <em>broadcastSubRequestBatchSize</em>. <em>broadcastSubRequestBatchSize</em> defines the upper limit of the number of Sub-requests that can be processed at any given time.</p> <p>As an example, assuming the total number of subscribers for a notification is 1,000,000, <em>broadcastSubscriberChunkSize</em> is 1,000 and <em>broadcastSubRequestBatchSize</em> is 10, <em>NotifyBC</em> will divide the 1M subscribers into 1,000 chunks and generates 1,000 sub-requests, one for each chunk. The 1,000 sub-requests will be submitted back to <em>NotifyBC</em> cluster to be processed. The original request will ensure at most 10 sub-requests are submitted and being processed at any given time. In fact, the only time concurrency is less than 10 is near the end of the task when remaining sub-requests is less than 10. When a sub-request is received by <em>NotifyBC</em> cluster, all 1,000 subscribers are processed concurrently. Suppose each sub-request (i.e. 1,000 subscribers) takes 1 minute to process on average, then the total time to dispatch notifications to 1M subscribers takes 1,000/10 = 100min, or 1hr40min.</p> <p>The default value for <em>broadcastSubscriberChunkSize</em> and <em>broadcastSubRequestBatchSize</em> are defined in <em>/src/config.ts</em></p> <div class="language-ts extra-class"><pre class="language-ts"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  notification<span class="token operator">:</span> <span class="token punctuation">{</span>
    broadcastSubscriberChunkSize<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    broadcastSubRequestBatchSize<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>To customize, create the config with updated value in file <em>/src/config.local.js</em>.</p> <p>If total number of subscribers is less than <em>broadcastSubscriberChunkSize</em>, then no sub-requests are spawned. Instead, the main request dispatches all notifications.</p> <div class="custom-block tip"><p class="custom-block-title">How to determine the optimal value for <i>broadcastSubscriberChunkSize</i> and <i>broadcastSubRequestBatchSize</i>?</p> <p><i>broadcastSubscriberChunkSize</i> is determined by the concurrency capability of the downstream message handlers such as SMTP server or SMS service provider. <i>broadcastSubRequestBatchSize</i> is determined by the size of <i>NotifyBC</i> cluster. As a rule of thumb, set <i>broadcastSubRequestBatchSize</i> equal to the number of non-master nodes in <i>NotifyBC</i> cluster.</p></div> <h2 id="broadcast-push-notification-custom-filter-functions"><a href="#broadcast-push-notification-custom-filter-functions" class="header-anchor">#</a> Broadcast Push Notification Custom Filter Functions</h2> <div class="custom-block warning"><p class="custom-block-title">Advanced Topic</p> <p>Defining custom function requires knowledge of JavaScript and understanding how external libraries are added and referenced in Node.js. Setting a development environment to test the custom function is also recommended.</p></div> <p>To support rule-based notification event filtering, <em>NotifyBC</em> uses a <a href="https://github.com/f-w/jmespath.js" target="_blank" rel="noopener noreferrer">modified version<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of <a href="http://jmespath.org/" target="_blank" rel="noopener noreferrer">jmespath<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to implement json query. The modified version allows defining custom functions that can be used in <a href="../api-subscription#broadcastPushNotificationFilter">broadcastPushNotificationFilter</a> field of subscription API and <a href="../api-notification#broadcastPushNotificationSubscriptionFilter">broadcastPushNotificationSubscriptionFilter</a> field of subscription API. The functions must be implemented using JavaScript in config <em>notification.broadcastCustomFilterFunctions</em>. The functions can even be <em>async</em>. For example, the case-insensitive string matching function <em>contains_ci</em> shown in the example of that field can be created in file <em>/src/config.local.js</em></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token literal-property property">notification</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">broadcastCustomFilterFunctions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">contains_ci</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">_func</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolvedArgs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span>resolvedArgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">toLower</span><span class="token punctuation">(</span>resolvedArgs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">toLower</span><span class="token punctuation">(</span>resolvedArgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">_signature</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">types</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Consult jmespath.js source code on the <a href="https://github.com/f-w/jmespath.js/blob/master/jmespath.js#L1127" target="_blank" rel="noopener noreferrer">functionTable syntax<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://github.com/f-w/jmespath.js/blob/master/jmespath.js#L132" target="_blank" rel="noopener noreferrer">type constants<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> used by above code. Note the function can use any Node.js modules (<em><a href="https://lodash.com/" target="_blank" rel="noopener noreferrer">lodash<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></em> in this case).</p> <div class="custom-block tip"><p class="custom-block-title">install additional Node.js modules</p> <p>The recommended way to install additional Node.js modules is by running command <i><a href="https://docs.npmjs.com/cli/install">npm install &lt;your_module&gt;</a></i> from the directory one level above <i>NotifyBC</i> root. For example, if
<i>NotifyBC</i> is installed on <i>/data/notifyBC</i>, then run the command from directory <i>/data</i>. The command will then install the module to <i>/data/node_modules/&lt;your_module&gt;</i>.</p></div> <h2 id="guaranteed-broadcast-push-dispatch-processing"><a href="#guaranteed-broadcast-push-dispatch-processing" class="header-anchor">#</a> Guaranteed Broadcast Push Dispatch Processing</h2> <p>As a major enhancement in v3, by default <em>NotifyBC</em> guarantees all subscribers
of a broadcast push notification will be processed in spite of
<em>NotifyBC</em> node failures during dispatching. Node failure is a concern because
the time takes to dispatch broadcast push notification is proportional
to number of subscribers, which is potentially large.</p> <p>The guarantee is achieved by</p> <ol><li>logging the dispatch result to database individually right after each dispatch</li> <li>when subscribers are divided into chunks and a chunk sub-request fails, the original request re-submits the sub-request</li> <li>the original request periodically updates the notification <em>updated</em> timestamp field as heartbeat during dispatching</li> <li>if original request fails,
<ol><li>a cron job detects the failure from the stale timestamp, and re-submits the original request</li> <li>all chunk sub-requests detects the the failure from the socket error, and stop processing</li></ol></li></ol> <p>Guaranteed processing doesn't mean notification will be dispatched to every
intended subscriber, however. Dispatch can still be rejected by smtp/sms
server. Furthermore, even if dispatch is successful,
it only means the sending is successful. It doesn't guarantee the
recipient receives the notification. <a href="/NotifyBC/docs/config/email.html#bounce">Bounce</a>
may occur for a successful dispatch, for instance; or the recipient may not
read the message.</p> <p>The guarantee comes at a performance penalty because result of each
dispatch is written to database one by one, taking a toll on the database.
It should be noted that the <a href="/NotifyBC/docs/miscellaneous/benchmarks.html">benchmarks</a> were conducted
without the guarantee.</p> <p>If performance is a higher priority to you, disable both the guarantee and
bounce handling by setting config
<em>notification.guaranteedBroadcastPushDispatchProcessing</em> and <em>email.bounce.enabled</em> to
<em>false</em> in file <em>/src/config.local.js</em></p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">notification</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">guaranteedBroadcastPushDispatchProcessing</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bounce</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">enabled</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>In such case only failed dispatches are written to <em>dispatch.failed</em> field of the notification.</p> <h3 id="also-log-skipped-dispatches-for-broadcast-push-notifications"><a href="#also-log-skipped-dispatches-for-broadcast-push-notifications" class="header-anchor">#</a> Also log skipped dispatches for broadcast push notifications</h3> <p>When <em>guaranteedBroadcastPushDispatchProcessing</em> is <em>true</em>, by default only successful and failed dispatches are logged, along with dispatch candidates. Dispatches that are skipped by filters defined at subscription (<em>broadcastPushNotificationFilter</em>) or notification (<em>broadcastPushNotificationSubscriptionFilter</em>) are not logged for performance reason. If you also want skipped dispatches to be logged to <em>dispatch.skipped</em> field of the notification, set <em>logSkippedBroadcastPushDispatches</em> to <em>true</em> in file <em>/src/config.local.js</em></p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token literal-property property">notification</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token literal-property property">logSkippedBroadcastPushDispatches</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Setting <em>logSkippedBroadcastPushDispatches</em> to <em>true</em> only has effect when <em>guaranteedBroadcastPushDispatchProcessing</em> is <em>true</em>.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/NotifyBC/docs/config-subscription/" class="prev">
        Subscription
      </a></span> <span class="next"><a href="/NotifyBC/docs/config-nodeRoles/">
        Node Roles
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/NotifyBC/assets/js/app.de6582d6.js" defer></script><script src="/NotifyBC/assets/js/4.f52469e6.js" defer></script><script src="/NotifyBC/assets/js/5.837d8809.js" defer></script><script src="/NotifyBC/assets/js/27.1fc62055.js" defer></script>
  </body>
</html>
